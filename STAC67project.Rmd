---
title: 'STAC67 Case Study: Predictive Model For The Median Value Of Homes In Boston'
author: Group 18 / Abbas Rai 1003957104 / Calvin Chan 999940364 / Huan Wang 1001707049/
  Ruotong Zheng 1002586659/ Andrey Zhuravlev
output:
  word_document: default
  html_document:
    df_print: paged
  pdf_document: default
  html_notebook: default
---
#Abstract
Buying a home is one of the most important purchase decisions in one’s life. There are many important factors for one to consider, especially the value of the home one is purchasing. In reality, the value of a home can be evaluated based on an in-depth analysis of the home’s geographical location and several other environmental and socioeconomic factors. Our team has used a plethora of statistical tests and considered several influential variables associated with this important topic in order to develop a predictive model which best explains the value of homes in the city of Boston.

#Background and Significance
The debate surrounding purchasing the "ideal" home is one that is extremely prevalent within households across the globe. People work extremely hard to save up to buy a home, making it one of the most important investments in one's lifetime. In fact, research shows that it takes the average American more than seven years to save up enough money just to deposit the down payment towards a home (Olsen, 2018). Moreover, future home buyers find themselves in an even more vulnerable position. Due to inflation and increasing price levels within the economy, there has been an increasing trend of the time needed to save up for a home in America, which has already risen by almost two years since 1988 (Olsen, 2018). The presence of these trends makes it even more important for individuals to make smart home purchases, in order to avoid facing severe economic repercussions. One of the fundamental factors which affects the value of a home is safety. A report published by the Center for American Progress concluded that “a 10% reduction in homicides would lead to a 0.83% increase in housing values the following year.” (Byloos, 2016). In addition, one must consider the presence of retail stores in the nearby area, which can actually lower the value of a house if located within close proximity (Matthews, 2006). We ultimately propose the following model to predict the median house price levels in Boston in order to provide home buyers and real estate agents with more holistic understanding of the factors which influence the value of homes and provide them with the necessary information to understand the housing market better and make better decisions overall.


```{r include = FALSE}
#data
library(tidyverse)
housing <- read.csv("housing.proper.csv")
housing
summary(housing)
```
```{r echo = FALSE}
Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

apply(housing, 2, Mode)
```
```{r echo = FALSE}
library(GGally)
ggcorr(housing[,1:14], name = "corr", label = TRUE)
```

#Model

```{r include = FALSE}
colnames(housing) <- c("X1","X2","X3","X4","X5","X6","X7",
                       "X8","X9","X10","X11","X12","X13","Y")
set.seed(67)
housing_mod <- housing[sample(nrow(housing), 253),c(1:14)]
fit_select <- lm(Y ~ X1 + X2 + X3 + X4 + X5 + X6 + X7 + X8 + X9 + X10 + X11 + X12 + X13, data = housing_mod)
summary(fit_select)
```

#Model Creation

Half the data set is choosen to create the model and other half is for validation. Seed is set to 67 for consistent results.
We used stepwise regression with function stepAIC with 12 variables which checks which variables have an Akaike's Information Criterion(AIC) lower than the threshold AIC.
X4 is ignored since only 6% of the data set has X4 at 1.
```{r include = FALSE}
library(MASS)
fit_select2 = lm(Y ~ X1 + X2 + X3 + X5 + X6 + X7 + X8 + X9 + X10 + X11 + X12 + X13, data = housing_mod)
step = stepAIC(fit_select2, direction = "both")
step$anova
```
The resulting model is Y ~ X2 + X5 + X6 + X8 + X9 + X10 + X11 + X12 + X13.

#Model validation

The remaining 50% of the data set is used for validation. We checked the difference between the Mean Square Prediction Error(MSPE) and the Mean Square Residual(MSRes).
```{r include = FALSE}
#Model Selected
fit_sel <- lm(Y ~ X2 + X5 + X6 + X8 + X9 + X10 + X11 + X12 + X13, data = housing_mod)
#modify data set with the X's we need
newx <- housing[,c(2, 5, 6, 8:13)]
colnames(newx) <- c("X2","X5","X6","X8","X9","X10","X11","X12","X13")
#MSPE - MS_res
Y_pred <- predict(fit_sel, newx)
Y_obs <- housing[,14] 
n_star <- nrow(newx)
MSPE <- sum( (Y_obs-Y_pred)^2/n_star )
MS_res <- (summary(fit_sel)$sigma)^2

MSPE
MS_res
sum(MSPE - MS_res)
```
We got 23.217 as the MSPE and 22.251 for the MSRes. The difference(0.966) is fairly close so we can validate this model

#Model diagnostics

##Residuals Vs. Fitted Values

```{r echo = FALSE}
#Functional form
#library(car)
#our model with the whole data set
fit <- lm(Y ~ X2 + X5 + X6 + X8 + X9 + X10 + X11 + X12 + X13, data = housing)
#par(mfrow = c(2,2), oma = c(1,1,0,0), 
#    mar = c(2,2,2,2), tcl = -0.1, mgp = c(1,0,0))

#plot(fit$residuals~fit$fitted.values, xlab = "Fitted values", ylab = "Residuals", main = "Residuals Vs. Fitted Values")
#abline(h = 0)
#par(mfrow = c(1,1))

plot(fit, which=c(1))
```

The Residuals vs Fitted plot shows a random spread points therefore it indicates a proper functional form.

##Normal Q-Q Plot

```{r echo = FALSE}
plot(fit, which=c(2))
```

The normal Q-Q plot shows that the errors are normally distributed. Most of the residuals follow the straight line but there are many residuals off the line towards the ends. 
There are three noteworthy points of 369, 373, and 372. Since most of the residuals are along the line, there is no indication that normality is violated.

##Scale-Location

```{r echo = FALSE}
plot(fit, which=c(3))
```

##Outlying Y observations

```{r include = FALSE}
library(car)
# Statistical test
outlierTest(fit)
# Studentized deleted residuals
t <- rstudent(fit)
alpha <- 0.05
n <- length(housing$Y)
p_prime = length(coef(fit)) 
t_crit <- qt(1-alpha/(2*n),n-p_prime-1)
round(t,2)
t_crit
which(abs(t) > t_crit)
```
We found the threshold(t_crit) to be 3.925493. Using studentized deleted residuals we found that observations 369, 370, 372,and 373 above the threshold and therefore are the outlying Y observations.

##Outlying X observations (Leverage)

```{r include = FALSE}
Pii <- hatvalues(fit)
round(Pii, 2)
which(Pii > 2*p_prime/n)
which(Pii > 0.5)
```
No leverage points is with guideline 2 which is Pii > 0.5.
With the guideline Pii > 2*p_prime/n there are 46 leverage points.

[9, 49, 55, 103, 142, 143, 144, 145, 146, 147, 148, 149 151, 152, 153, 154, 155, 156, 157, 160, 204, 205, 254, 258, 291, 292, 293, 352, 353, 354, 355, 356, 365, 366, 368, 369, 375, 411, 413, 415, 425, 489, 490, 491, 492, 493]

##Influence

```{r echo = FALSE}
influencePlot(fit, main="Influence Plot", sub="Circle size is proportial to Cook's Distance" )
```
```{r include = FALSE}
DFFITS <- dffits(fit)
which(DFFITS > 1)
#which(DFFITS > 2*sqrt(p_prime/n))
```
There is only one data point that has a DFFITS greater than 1 which is 369.
```{r include = FALSE}
D <- cooks.distance(fit)
which(D > qf(0.2, p_prime, n-p_prime))
```
There are no observations with a Cooks Distance greater than the 20th percentile of F(10,496) = 0.6168.
```{r include = FALSE}
DFBETAS <- dfbetas(fit)
which(DFBETAS > 1)
#which(DFBETAS > 2/(sqrt(n)))
```
There are no observations with a DFBETAS greater than 1.
```{r echo = FALSE}
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page
new_data <- housing[-c(369),]
new_fit <- lm(Y ~ X2 + X5 + X6 + X8 + X9 + X10 + X11 + X12 + X13, data = new_data)
plot(new_fit)
```

#References
Olsen, S. (2018, October 22). Home Buyers Need 7.2 Years to Save Down Payments – 1.5 Years More Than in 1988. Retrieved from https://www.zillow.com/research/how-many-years-down-payment-21734/

Byloos, M. (2016). Research Crime Rates and the Impact on Home Values | Homes.com. Retrieved from https://www.homes.com/blog/2016/05/secure-new-home-research-crime-rates-impact-home-value/

Matthews, J. (2006). Retail Proximity and Residential Values or Do Nearby Stores Really Run Down Property Values?. SSRN Electronic Journal. doi: 10.2139/ssrn.989049
